<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Historial de Transacciones - Pokémon Bank ATM</title>
    
    <!-- Bootstrap 4.6 -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.6.0/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome 6 -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- CSS principal del proyecto -->
    <link href="css/style.css" rel="stylesheet">
</head>
<body>
    <!-- Contenedor principal del historial -->
    <div class="history-container">
        
        <!-- Header del historial -->
        <div class="history-header">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="login-title mb-2">Historial de Transacciones</h1>
                    <p class="text-muted mb-0" id="user-info">Cargando información del usuario...</p>
                </div>
                <div class="text-right">
                    <button class="btn btn-outline-secondary" onclick="goBack()">
                        <i class="fas fa-arrow-left"></i> Volver
                    </button>
                </div>
            </div>
        </div>

        <!-- Sección de filtros -->
        <div class="filters-section">
            <h4 class="mb-3">
                <i class="fas fa-filter"></i> Filtrar Transacciones
            </h4>
            
            <div class="row">
                <div class="col-lg-3 col-md-6 mb-3">
                    <label for="filterType" class="form-label">Tipo de Transacción</label>
                    <select id="filterType" class="form-control" onchange="applyFilters()">
                        <option value="all">Todas las transacciones</option>
                        <option value="deposit">Depósitos</option>
                        <option value="withdrawal">Retiros</option>
                        <option value="payment">Pagos de Servicios</option>
                        <option value="inquiry">Consultas</option>
                    </select>
                </div>
                
                <div class="col-lg-3 col-md-6 mb-3">
                    <label for="filterDateFrom" class="form-label">Fecha Desde</label>
                    <input type="date" id="filterDateFrom" class="form-control" onchange="applyFilters()">
                </div>
                
                <div class="col-lg-3 col-md-6 mb-3">
                    <label for="filterDateTo" class="form-label">Fecha Hasta</label>
                    <input type="date" id="filterDateTo" class="form-control" onchange="applyFilters()">
                </div>
                
                <div class="col-lg-3 col-md-6 mb-3">
                    <label for="searchText" class="form-label">Buscar</label>
                    <input type="text" id="searchText" class="form-control" placeholder="Descripción, ubicación..." onkeyup="applyFilters()">
                </div>
            </div>
            
            <div class="row">
                <div class="col-12">
                    <button class="btn btn-primary" onclick="clearFilters()">
                        <i class="fas fa-times"></i> Limpiar Filtros
                    </button>
                    <button class="btn btn-success ml-2" onclick="exportToPDF()">
                        <i class="fas fa-file-pdf"></i> Exportar PDF
                    </button>
                </div>
            </div>
        </div>

        <!-- Estadísticas resumidas -->
        <div class="stats-grid" id="statsContainer">
            <!-- Las estadísticas se cargarán dinámicamente -->
        </div>

        <!-- Lista de transacciones -->
        <div class="transactions-section">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="mb-0">
                    <i class="fas fa-list"></i> Movimientos Recientes
                </h4>
                <div>
                    <span class="text-muted" id="results-count">Mostrando 0 resultados</span>
                </div>
            </div>
            
            <!-- Contenedor de transacciones -->
            <div id="transactionsContainer">
                <!-- Las transacciones se cargarán dinámicamente -->
            </div>
            
            <!-- Loading state -->
            <div id="loadingState" class="text-center py-5" style="display: none;">
                <div class="spinner-border text-primary" role="status">
                    <span class="sr-only">Cargando...</span>
                </div>
                <p class="mt-3 text-muted">Cargando transacciones...</p>
            </div>
            
            <!-- Empty state -->
            <div id="emptyState" class="text-center py-5" style="display: none;">
                <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">No se encontraron transacciones</h5>
                <p class="text-muted">Intenta ajustar los filtros de búsqueda</p>
            </div>
        </div>

        <!-- Paginación -->
        <div class="pagination-container" id="paginationContainer">
            <!-- La paginación se cargará dinámicamente -->
        </div>

    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.6.0/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="js/historial.js"></script>
    
    <script>
        // Variables globales
        let currentPage = 1;
        const itemsPerPage = 10;
        let filteredTransactions = [];
        let allTransactions = [];

        // Datos del historial (incluir en historial.js posteriormente)
        const historialData = {
            user: {
                name: "Ash Ketchum",
                accountNumber: "1234-5678-9012",
                balance: 25750.00
            },
            transactions: [
                {
                    id: 1,
                    date: "2025-09-18",
                    time: "14:30",
                    type: "deposit",
                    description: "Depósito en efectivo",
                    location: "Sucursal Centro Pokémon",
                    reference: "DEP-20250918-001",
                    amount: +1500.00,
                    balance: 25750.00,
                    status: "completed"
                },
                {
                    id: 2,
                    date: "2025-09-17",
                    time: "10:15",
                    type: "withdrawal",
                    description: "Retiro de efectivo",
                    location: "ATM Plaza Kanto",
                    reference: "WTH-20250917-002",
                    amount: -800.00,
                    balance: 24250.00,
                    status: "completed"
                },
                {
                    id: 3,
                    date: "2025-09-16",
                    time: "16:45",
                    type: "payment",
                    description: "Pago Energía Eléctrica",
                    location: "ATM Centro Johto",
                    reference: "PAY-ELEC-789456123",
                    amount: -165.75,
                    balance: 25050.00,
                    status: "completed"
                },
                {
                    id: 4,
                    date: "2025-09-15",
                    time: "09:20",
                    type: "inquiry",
                    description: "Consulta de saldo",
                    location: "ATM Centro Comercial",
                    reference: "INQ-20250915-004",
                    amount: 0.00,
                    balance: 25215.75,
                    status: "completed"
                },
                {
                    id: 5,
                    date: "2025-09-14",
                    time: "18:30",
                    type: "payment",
                    description: "Pago Internet",
                    location: "ATM Sucursal Norte",
                    reference: "PAY-INT-456789012",
                    amount: -89.99,
                    balance: 25215.75,
                    status: "completed"
                },
                {
                    id: 6,
                    date: "2025-09-13",
                    time: "11:45",
                    type: "deposit",
                    description: "Transferencia recibida",
                    location: "Transfer Automático",
                    reference: "TRF-20250913-006",
                    amount: +2500.00,
                    balance: 25305.74,
                    status: "completed"
                },
                {
                    id: 7,
                    date: "2025-09-12",
                    time: "14:20",
                    type: "withdrawal",
                    description: "Retiro de efectivo",
                    location: "ATM Cerulean City",
                    reference: "WTH-20250912-007",
                    amount: -400.00,
                    balance: 22805.74,
                    status: "completed"
                },
                {
                    id: 8,
                    date: "2025-09-11",
                    time: "13:15",
                    type: "payment",
                    description: "Pago Agua Potable",
                    location: "ATM Lavender Town",
                    reference: "PAY-WAT-234567890",
                    amount: -45.50,
                    balance: 23205.74,
                    status: "completed"
                }
            ]
        };

        // Funciones de utilidad
        function formatCurrency(amount) {
            return new Intl.NumberFormat('es-SV', {
                style: 'currency',
                currency: 'USD'
            }).format(amount);
        }

        function formatDate(date) {
            return new Date(date).toLocaleDateString('es-SV', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        function formatTime(time) {
            return time;
        }

        // Función para obtener transacciones filtradas
        function getFilteredTransactions() {
            let transactions = [...historialData.transactions];
            
            // Filtrar por tipo
            const typeFilter = document.getElementById('filterType').value;
            if (typeFilter !== 'all') {
                transactions = transactions.filter(t => t.type === typeFilter);
            }
            
            // Filtrar por fecha desde
            const dateFrom = document.getElementById('filterDateFrom').value;
            if (dateFrom) {
                transactions = transactions.filter(t => new Date(t.date) >= new Date(dateFrom));
            }
            
            // Filtrar por fecha hasta
            const dateTo = document.getElementById('filterDateTo').value;
            if (dateTo) {
                transactions = transactions.filter(t => new Date(t.date) <= new Date(dateTo));
            }
            
            // Filtrar por texto de búsqueda
            const searchText = document.getElementById('searchText').value.toLowerCase();
            if (searchText) {
                transactions = transactions.filter(t => 
                    t.description.toLowerCase().includes(searchText) ||
                    t.location.toLowerCase().includes(searchText) ||
                    t.reference.toLowerCase().includes(searchText)
                );
            }
            
            // Ordenar por fecha (más reciente primero)
            transactions.sort((a, b) => {
                const dateA = new Date(a.date + 'T' + a.time);
                const dateB = new Date(b.date + 'T' + b.time);
                return dateB - dateA;
            });
            
            return transactions;
        }

        // Función para calcular estadísticas
        function calculateStats(transactions) {
            const stats = {
                total: transactions.length,
                deposits: 0,
                withdrawals: 0,
                payments: 0,
                inquiries: 0,
                depositAmount: 0,
                withdrawalAmount: 0,
                paymentAmount: 0
            };
            
            transactions.forEach(t => {
                const amount = Math.abs(t.amount);
                switch(t.type) {
                    case 'deposit':
                        stats.deposits++;
                        stats.depositAmount += amount;
                        break;
                    case 'withdrawal':
                        stats.withdrawals++;
                        stats.withdrawalAmount += amount;
                        break;
                    case 'payment':
                        stats.payments++;
                        stats.paymentAmount += amount;
                        break;
                    case 'inquiry':
                        stats.inquiries++;
                        break;
                }
            });
            
            return stats;
        }

        // Función para renderizar estadísticas
        function renderStats(transactions) {
            const stats = calculateStats(transactions);
            const statsContainer = document.getElementById('statsContainer');
            
            statsContainer.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${stats.total}</div>
                    <div class="text-muted">Total Transacciones</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value amount-positive">+${formatCurrency(stats.depositAmount)}</div>
                    <div class="text-muted">Total Depósitos (${stats.deposits})</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value amount-negative">-${formatCurrency(stats.withdrawalAmount)}</div>
                    <div class="text-muted">Total Retiros (${stats.withdrawals})</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value amount-negative">-${formatCurrency(stats.paymentAmount)}</div>
                    <div class="text-muted">Pagos de Servicios (${stats.payments})</div>
                </div>
            `;
        }

        // Función para renderizar transacciones
        function renderTransactions(transactions, page = 1) {
            const container = document.getElementById('transactionsContainer');
            const startIndex = (page - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageTransactions = transactions.slice(startIndex, endIndex);
            
            if (pageTransactions.length === 0) {
                document.getElementById('emptyState').style.display = 'block';
                container.innerHTML = '';
                return;
            }
            
            document.getElementById('emptyState').style.display = 'none';
            
            container.innerHTML = pageTransactions.map(transaction => `
                <div class="transaction-item">
                    <div class="row align-items-center">
                        <div class="col-md-2">
                            <div class="font-weight-bold">${formatDate(transaction.date)}</div>
                            <small class="text-muted">${formatTime(transaction.time)}</small>
                        </div>
                        <div class="col-md-3">
                            <span class="transaction-type type-${transaction.type}">
                                ${getTypeLabel(transaction.type)}
                            </span>
                        </div>
                        <div class="col-md-4">
                            <div class="font-weight-bold">${transaction.description}</div>
                            <small class="text-muted">${transaction.location}</small>
                            <br><small class="text-muted">Ref: ${transaction.reference}</small>
                        </div>
                        <div class="col-md-2 text-right">
                            <div class="font-weight-bold ${transaction.amount >= 0 ? 'amount-positive' : 'amount-negative'}">
                                ${transaction.amount >= 0 ? '+' : ''}${formatCurrency(Math.abs(transaction.amount))}
                            </div>
                        </div>
                        <div class="col-md-1 text-right">
                            <small class="text-muted">${formatCurrency(transaction.balance)}</small>
                        </div>
                    </div>
                </div>
            `).join('');
            
            // Actualizar contador de resultados
            document.getElementById('results-count').textContent = 
                `Mostrando ${startIndex + 1}-${Math.min(endIndex, transactions.length)} de ${transactions.length} resultados`;
        }

        // Función para obtener etiqueta del tipo
        function getTypeLabel(type) {
            const labels = {
                'deposit': 'Depósito',
                'withdrawal': 'Retiro',
                'payment': 'Pago Servicio',
                'inquiry': 'Consulta'
            };
            return labels[type] || type;
        }

        // Función para renderizar paginación
        function renderPagination(transactions, currentPage) {
            const totalPages = Math.ceil(transactions.length / itemsPerPage);
            const container = document.getElementById('paginationContainer');
            
            if (totalPages <= 1) {
                container.innerHTML = '';
                return;
            }
            
            let paginationHTML = '<nav><ul class="pagination justify-content-center">';
            
            // Botón anterior
            paginationHTML += `
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link pagination-btn" href="#" onclick="changePage(${currentPage - 1})">
                        <i class="fas fa-chevron-left"></i>
                    </a>
                </li>
            `;
            
            // Números de página
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    paginationHTML += `
                        <li class="page-item ${i === currentPage ? 'active' : ''}">
                            <a class="page-link pagination-btn" href="#" onclick="changePage(${i})">${i}</a>
                        </li>
                    `;
                } else if (i === currentPage - 3 || i === currentPage + 3) {
                    paginationHTML += '<li class="page-item disabled"><span class="page-link">...</span></li>';
                }
            }
            
            // Botón siguiente
            paginationHTML += `
                <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link pagination-btn" href="#" onclick="changePage(${currentPage + 1})">
                        <i class="fas fa-chevron-right"></i>
                    </a>
                </li>
            `;
            
            paginationHTML += '</ul></nav>';
            container.innerHTML = paginationHTML;
        }

        // Función para cambiar de página
        function changePage(page) {
            const totalPages = Math.ceil(filteredTransactions.length / itemsPerPage);
            if (page < 1 || page > totalPages) return;
            
            currentPage = page;
            renderTransactions(filteredTransactions, currentPage);
            renderPagination(filteredTransactions, currentPage);
        }

        // Función para aplicar filtros
        function applyFilters() {
            currentPage = 1;
            filteredTransactions = getFilteredTransactions();
            renderStats(filteredTransactions);
            renderTransactions(filteredTransactions, currentPage);
            renderPagination(filteredTransactions, currentPage);
        }

        // Función para limpiar filtros
        function clearFilters() {
            document.getElementById('filterType').value = 'all';
            document.getElementById('filterDateFrom').value = '';
            document.getElementById('filterDateTo').value = '';
            document.getElementById('searchText').value = '';
            applyFilters();
        }

        // Función para volver
        function goBack() {
            // Intentar ir a dashboard.html o usar history.back()
            if (document.referrer) {
                window.history.back();
            } else {
                window.location.href = 'PantallaAcciones.html';
            }
        }

        // Función para exportar a PDF
        function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Configuración del documento
            doc.setFontSize(20);
            doc.text('Historial de Transacciones', 20, 30);
            
            // Información del usuario
            doc.setFontSize(12);
            doc.text(`Usuario: ${historialData.user.name}`, 20, 50);
            doc.text(`Cuenta: ${historialData.user.accountNumber}`, 20, 60);
            doc.text(`Saldo Actual: ${formatCurrency(historialData.user.balance)}`, 20, 70);
            doc.text(`Fecha de Reporte: ${new Date().toLocaleDateString()}`, 20, 80);
            
            // Estadísticas
            const stats = calculateStats(filteredTransactions);
            doc.text('Resumen de Transacciones:', 20, 100);
            doc.text(`Total de Transacciones: ${stats.total}`, 25, 110);
            doc.text(`Depósitos: ${stats.deposits} (${formatCurrency(stats.depositAmount)})`, 25, 120);
            doc.text(`Retiros: ${stats.withdrawals} (${formatCurrency(stats.withdrawalAmount)})`, 25, 130);
            doc.text(`Pagos: ${stats.payments} (${formatCurrency(stats.paymentAmount)})`, 25, 140);
            
            // Tabla de transacciones
            doc.text('Detalle de Transacciones:', 20, 160);
            
            let yPosition = 170;
            const maxTransactions = Math.min(filteredTransactions.length, 15); // Límite para primera página
            
            for (let i = 0; i < maxTransactions; i++) {
                const transaction = filteredTransactions[i];
                
                if (yPosition > 270) {
                    doc.addPage();
                    yPosition = 20;
                }
                
                // Línea de transacción
                doc.setFontSize(10);
                doc.text(`${formatDate(transaction.date)} ${transaction.time}`, 20, yPosition);
                doc.text(getTypeLabel(transaction.type), 70, yPosition);
                doc.text(transaction.description.substring(0, 25), 100, yPosition);
                doc.text(`${transaction.amount >= 0 ? '+' : ''}${formatCurrency(Math.abs(transaction.amount))}`, 150, yPosition);
                
                yPosition += 10;
            }
            
            // Nota si hay más transacciones
            if (filteredTransactions.length > maxTransactions) {
                doc.text(`... y ${filteredTransactions.length - maxTransactions} transacciones más`, 20, yPosition + 10);
            }
            
            // Pie de página
            doc.setFontSize(8);
            doc.text('Pokémon Bank ATM - Reporte generado automáticamente', 20, 290);
            
            // Descargar archivo
            const fileName = `historial_${historialData.user.name.replace(' ', '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(fileName);
            
            // Mostrar confirmación
            alert('Reporte PDF generado y descargado exitosamente');
        }

        // Inicialización cuando se carga la página
        document.addEventListener('DOMContentLoaded', function() {
            // Cargar información del usuario
            document.getElementById('user-info').textContent = 
                `${historialData.user.name} • Cuenta: ${historialData.user.accountNumber} • Saldo: ${formatCurrency(historialData.user.balance)}`;
            
            // Cargar transacciones inicial
            allTransactions = historialData.transactions;
            filteredTransactions = [...allTransactions];
            
            // Renderizar todo
            renderStats(filteredTransactions);
            renderTransactions(filteredTransactions, currentPage);
            renderPagination(filteredTransactions, currentPage);
        });
    </script>
</body>
</html>